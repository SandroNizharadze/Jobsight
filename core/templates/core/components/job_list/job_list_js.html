<script>
document.addEventListener('DOMContentLoaded', function() {
  // Function to serialize form data to URL parameters
  function serializeForm(form) {
    const formData = new FormData(form);
    const searchParams = new URLSearchParams();
    
    for (const [key, value] of formData) {
      if (value) { // Only add parameters that have values
        searchParams.append(key, value);
      }
    }
    
    return searchParams.toString();
  }

  // Function to update URL without page refresh
  function updateURL(params) {
    const newURL = `${window.location.pathname}?${params}`;
    window.history.pushState({ path: newURL }, '', newURL);
  }

  // Function to update the job list container
  function updateJobList(html) {
    const jobListContainer = document.querySelector('.job-cards-container');
    const mobileJobListContainer = document.querySelector('.mobile-job-cards-container');
    
    if (jobListContainer) {
      jobListContainer.innerHTML = html;
    }
    if (mobileJobListContainer) {
      mobileJobListContainer.innerHTML = html;
    }
  }

  // Function to update active filters display
  function updateActiveFilters(html) {
    const activeFiltersContainers = document.querySelectorAll('.active-filters-container');
    activeFiltersContainers.forEach(container => {
      container.innerHTML = html;
    });
  }

  // Function to update job count
  function updateJobCount(count) {
    const countElements = document.querySelectorAll('.job-count');
    countElements.forEach(element => {
      element.textContent = `(${count} შედეგი)`;
    });
  }

  // Main function to handle filter changes
  async function handleFilterChange(formElement) {
    const params = serializeForm(formElement);
    
    try {
      // Show loading state
      document.body.classList.add('cursor-wait');
      
      // Make AJAX request
      const response = await fetch(`/jobs/filter/?${params}`, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      
      if (!response.ok) throw new Error('Network response was not ok');
      
      const data = await response.json();
      
      // Update the job list
      updateJobList(data.jobs_html);
      
      // Update active filters
      updateActiveFilters(data.filters_html);
      
      // Update job count
      updateJobCount(data.total_jobs);
      
      // Update URL
      updateURL(params);
      
    } catch (error) {
      console.error('Error:', error);
    } finally {
      // Remove loading state
      document.body.classList.remove('cursor-wait');
    }
  }

  // Debounce function
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Handle form submissions
  const filterForms = document.querySelectorAll('#filter-form, #mobile-filter-form');
  filterForms.forEach(form => {
    // Prevent default form submission
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      handleFilterChange(form);
    });

    // Handle auto-submit inputs
    const autoSubmitInputs = form.querySelectorAll('.filter-auto-submit');
    autoSubmitInputs.forEach(input => {
      if (input.type === 'text') {
        // Debounce text input changes
        input.addEventListener('input', debounce(() => {
          handleFilterChange(form);
        }, 500));
      } else if (input.type === 'range') {
        // Update value display immediately
        input.addEventListener('input', function() {
          const valueDisplay = document.getElementById(input.id === 'salary-slider' ? 'salary-value' : 'mobile-salary-value');
          if (valueDisplay) {
            valueDisplay.textContent = '₾ ' + this.value;
          }
        });
        
        // Handle actual filter change after sliding stops
        input.addEventListener('change', () => {
          handleFilterChange(form);
        });
      } else {
        // Handle immediate changes for other inputs
        input.addEventListener('change', () => {
          handleFilterChange(form);
        });
      }
    });
  });

  // Handle reset filters
  const resetButtons = document.querySelectorAll('#reset-filters, #mobile-reset-filters');
  resetButtons.forEach(button => {
    button.addEventListener('click', function() {
      const form = this.closest('form');
      if (form) {
        // Reset all form inputs
        form.querySelectorAll('input[type="text"], select').forEach(input => {
          input.value = '';
        });
        
        form.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
          checkbox.checked = false;
        });
        
        const salarySlider = form.querySelector('input[type="range"]');
        if (salarySlider) {
          salarySlider.value = 0;
          const valueDisplay = document.getElementById(salarySlider.id === 'salary-slider' ? 'salary-value' : 'mobile-salary-value');
          if (valueDisplay) {
            valueDisplay.textContent = '₾ 0';
          }
        }
        
        // Trigger filter update
        handleFilterChange(form);
      }
    });
  });

  // Handle filter remove links
  document.addEventListener('click', function(e) {
    if (e.target.closest('.filter-remove-link')) {
      e.preventDefault();
      const link = e.target.closest('.filter-remove-link');
      const form = document.querySelector('#filter-form') || document.querySelector('#mobile-filter-form');
      
      if (form) {
        const filterName = link.dataset.filter;
        const input = form.querySelector(`[name="${filterName}"]`);
        
        if (input) {
          if (input.type === 'checkbox') {
            input.checked = false;
          } else {
            input.value = '';
          }
          
          handleFilterChange(form);
        }
      }
    }
  });
});
</script> 