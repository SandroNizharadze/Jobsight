{% load static %}
{% load i18n %}

<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}" style="background-color: rgb(9, 36, 60);">

<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-NVBR47B6');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-28X5PJN9VV"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-28X5PJN9VV');
    </script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Jobsight{% endblock %}</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
    <!-- Apple Touch Icon (Webclip) -->
    <link rel="apple-touch-icon" href="{% static 'images/webclip.png' %}">
    <link rel="apple-touch-icon-precomposed" href="{% static 'images/webclip.png' %}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!-- Microsoft Tile Icon -->
    <meta name="msapplication-TileImage" content="{% static 'images/webclip.png' %}">
    <meta name="msapplication-TileColor" content="#09243c">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Lora', 'serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Base styles */
        html, body {
            font-family: 'Lora', serif;
        }
        
        /* Icon size fixes */
        .fas, .far, .fab {
            font-size: inherit;
            line-height: inherit;
            vertical-align: middle;
        }
        
        /* Form styles */
        input[type="text"],
        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            outline: none;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Checkbox styles */
        input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        /* Safari-specific fixes */
        @media not all and (min-resolution:.001dpcm) {
            @supports (-webkit-appearance:none) {
                input[type="checkbox"] {
                    -webkit-appearance: checkbox !important;
                    appearance: checkbox !important;
                    opacity: 1 !important;
                    position: static !important;
                    width: 16px !important;
                    height: 16px !important;
                }
            }
        }
    </style>
    
    {% block extra_css %}{% endblock %}
    
    <!-- Session Management Script -->
    {% if user.is_authenticated %}
    <script>
        // Session management for authenticated users
        (function() {
            const SESSION_WARNING_TIME = 5 * 60 * 1000; // 5 minutes before expiry
            const SESSION_CHECK_INTERVAL = 60 * 1000; // Check every minute
            
            let sessionWarningShown = false;
            
            function checkSessionStatus() {
                fetch('/api/session-status/', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (response.status === 401) {
                        // Session expired, redirect to login
                        window.location.href = '/login/?next=' + encodeURIComponent(window.location.pathname);
                    } else if (response.status === 200) {
                        return response.json();
                    }
                })
                .then(data => {
                    if (data && data.session_expires_in) {
                        const timeUntilExpiry = data.session_expires_in * 1000; // Convert to milliseconds
                        
                        if (timeUntilExpiry <= SESSION_WARNING_TIME && !sessionWarningShown) {
                            showSessionWarning(timeUntilExpiry);
                        }
                    }
                })
                .catch(error => {
                    console.log('Session check failed:', error);
                });
            }
            
            function showSessionWarning(timeUntilExpiry) {
                sessionWarningShown = true;
                
                const warningDiv = document.createElement('div');
                warningDiv.id = 'session-warning';
                warningDiv.className = 'fixed top-4 right-4 bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded z-50 max-w-sm';
                warningDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium">
                                ${Math.floor(timeUntilExpiry / 60000)} minutes until session expires
                            </p>
                            <div class="mt-2">
                                <button onclick="extendSession()" class="text-sm bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded">
                                    Stay Logged In
                                </button>
                                <button onclick="logout()" class="text-sm text-yellow-600 hover:text-yellow-800 ml-2">
                                    Logout Now
                                </button>
                            </div>
                        </div>
                        <div class="ml-auto pl-3">
                            <button onclick="dismissWarning()" class="text-yellow-400 hover:text-yellow-600">
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(warningDiv);
                
                // Auto-remove after 30 seconds
                setTimeout(() => {
                    dismissWarning();
                }, 30000);
            }
            
            function dismissWarning() {
                const warning = document.getElementById('session-warning');
                if (warning) {
                    warning.remove();
                }
            }
            
            function extendSession() {
                fetch('/api/extend-session/', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        dismissWarning();
                        sessionWarningShown = false;
                        // Reset the warning timer
                        setTimeout(checkSessionStatus, SESSION_WARNING_TIME);
                    }
                })
                .catch(error => {
                    console.log('Failed to extend session:', error);
                });
            }
            
            function logout() {
                window.location.href = '/logout/';
            }
            
            // Make functions globally available
            window.extendSession = extendSession;
            window.logout = logout;
            window.dismissWarning = dismissWarning;
            
            // Start session monitoring
            setInterval(checkSessionStatus, SESSION_CHECK_INTERVAL);
            
            // Check on page load
            setTimeout(checkSessionStatus, 1000);
            
        })();
    </script>
    {% endif %}
</head>

<body class="bg-gray-50 {% if request.resolver_match.url_name == 'job_list' %}job-list-page{% endif %}">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NVBR47B6"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    {% include 'core/components/base/navbar.html' %}
    
    {% block hero_section %}{% endblock %}
    
    <div class="min-h-screen {% if request.resolver_match.url_name == 'job_list' %}job-list-content{% endif %}" id="main-content">
        {% include 'core/components/base/alerts.html' %}
        {% block content %}{% endblock %}
    </div>
    
    {% block bottom_section %}{% endblock %}
    
    {% include 'core/components/base/footer.html' %}
    
    <!-- Mobile Bottom Navigation - available on all pages -->
    {% include 'core/components/mobile/base/mobile_bottom_nav.html' %}
    
    <style>
        /* Add padding to main content on mobile to prevent navbar overlap */
        @media (max-width: 767px) {
            #main-content {
                padding-bottom: var(--mobile-navbar-height, 60px);
            }
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    {% include 'core/components/base/scripts.html' %}
    <script src="{% static 'core/js/filter_modal.js' %}"></script>
    {% block extra_js %}{% endblock %}
    
    <!-- Script to apply Georgian font to Georgian text -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Georgian Unicode range: U+10A0 to U+10FF
        const georgianRegex = /[\u10A0-\u10FF]/;
        
        // Function to check if text contains Georgian characters
        function hasGeorgianChars(text) {
            return georgianRegex.test(text);
        }
        
        // Function to process text nodes
        function processTextNodes(node) {
            if (node.nodeType === Node.TEXT_NODE) {
                const text = node.nodeValue.trim();
                if (text && hasGeorgianChars(text)) {
                    // If the parent is not already styled for Georgian
                    if (!node.parentElement.classList.contains('georgian-text') && 
                        !node.parentElement.classList.contains('jobsight-logo')) {
                        
                        // Create a span with Georgian font
                        const span = document.createElement('span');
                        span.className = 'georgian-text';
                        span.textContent = node.nodeValue;
                        
                        // Replace the text node with the span
                        node.parentNode.replaceChild(span, node);
                    }
                }
            } else if (node.nodeType === Node.ELEMENT_NODE) {
                // Skip elements that are already styled or should be skipped
                if (node.classList && (
                    node.classList.contains('jobsight-logo') || 
                    node.classList.contains('georgian-text'))) {
                    return;
                }
                
                // Process child nodes
                Array.from(node.childNodes).forEach(processTextNodes);
            }
        }
        
        // Process the entire body
        processTextNodes(document.body);
        
        // Fix for job list page on mobile
        if (document.body.classList.contains('job-list-page') && window.innerWidth < 768) {
            document.querySelector('.job-list-content').style.minHeight = 'auto';
        }
    });
    </script>
    
    <!-- Safari-specific fixes -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (document.documentElement.classList.contains('safari')) {
                console.log('Applying Safari-specific JS fixes');
                
                // Fix Safari gradients
                document.querySelectorAll('.bg-gradient-to-br').forEach(function(el) {
                    el.style.backgroundImage = 'none';
                    if (el.classList.contains('from-purple-500')) {
                        el.style.backgroundColor = '#8b5cf6';
                    } else if (el.classList.contains('from-teal-500')) {
                        el.style.backgroundColor = '#14b8a6';
                    } else if (el.classList.contains('bg-amber-500')) {
                        el.style.backgroundColor = '#f59e0b';
                    }
                });
                
                // Fix border radius rendering
                document.querySelectorAll('.rounded-2xl, .rounded-3xl, .rounded-xl, .rounded-full').forEach(function(el) {
                    el.style.overflow = 'hidden';
                    el.style.webkitMaskImage = '-webkit-radial-gradient(white, black)';
                });
                
                // Fix CTA box
                const ctaBox = document.querySelector('.enhanced-cta-box');
                if (ctaBox) {
                    ctaBox.style.borderRadius = '1.5rem 1.5rem 0 0';
                    ctaBox.style.backgroundImage = 'none';
                    ctaBox.style.backgroundColor = '#edf2fa';
                }
                
                // Fix form elements
                document.querySelectorAll('input, select, button').forEach(function(el) {
                    el.style.webkitAppearance = 'none';
                    el.style.appearance = 'none';
                    el.style.borderRadius = '0.75rem';
                });
            }
        });
    </script>
</body>
</html> 